version: '3.8'

# Keycloak HTTPS Configuration
# Use this file with docker-compose -f docker-compose-https.yml for HTTPS deployments
# 
# Environment Variables Required:
#   KEYCLOAK_CERT_PATH: Path to directory containing keycloak.crt and keycloak.key
#   KEYCLOAK_HOSTNAME: Hostname for Keycloak (e.g., smart-dell-sml.crs4.it)

services:
  keycloak:
    image: keycloak/keycloak:latest
    container_name: keycloak-test
    ports:
      # HTTP port (for backward compatibility)
      - "8080:8080"
      # HTTPS port
      - "8443:8443"
    environment:
      KEYCLOAK_ADMIN: admin              # Master realm admin username
      KEYCLOAK_ADMIN_PASSWORD: admin     # Master realm admin password
      KC_DB: dev-mem                     # In-memory database (development only)
      KC_METRICS_ENABLED: 'false'        # Disable metrics in dev
      KC_HEALTH_ENABLED: 'true'          # Enable health checks
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-keycloak.local}
      KC_SCHEME: https                   # Use HTTPS
      KC_HTTP_PORT: 8080
      KC_HTTPS_PORT: 8443
      # HTTPS configuration
      KC_HTTP_ENABLED: 'true'            # Admin console accessible via HTTP too
      KC_PROXY: reencrypt                # Trust reverse proxy headers
      # Feature flags for testing (match docker-compose.yml)
      KC_FEATURES: 'admin-fine-grained-authz:v1,organization,client-policies'
    volumes:
      # Mount certificates for HTTPS
      - "${KEYCLOAK_CERT_PATH}/keycloak.crt:/etc/keycloak/certs/keycloak.crt:ro"
      - "${KEYCLOAK_CERT_PATH}/keycloak.key:/etc/keycloak/certs/keycloak.key:ro"
    command:
      - start-dev
      - "--https-certificate-file=/etc/keycloak/certs/keycloak.crt"
      - "--https-certificate-key-file=/etc/keycloak/certs/keycloak.key"
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:8443/health/ready"]
      interval: 5s
      timeout: 5s
      retries: 12    # Wait up to 60 seconds for Keycloak to be ready
    networks:
      - keycloak-network

networks:
  keycloak-network:
    driver: bridge
