# Keycloak Deployment Setup Guide

## Quick Start

### Local HTTP (Development)
```bash
npm run setup-keycloak
# Select: 1 (Local)
# Select: 1 (HTTP)
# ✓ Keycloak accessible at http://localhost:8080
```

### Local HTTPS (Production-like)
```bash
npm run setup-keycloak
# Select: 1 (Local)
# Select: 2 (HTTPS)
# 
# If certificates exist in test/docker-keycloak/certs:
#   ✓ Script automatically uses them
# 
# Otherwise, enter certificate path when prompted:
#   Certificate directory path: /path/to/certs
#   (or press Enter to use default location)
# 
# ✓ Keycloak accessible at https://localhost:8443
```

### Remote HTTP
```bash
npm run setup-keycloak
# Choose deployment: Remote (auto-selected, no Docker locally)
# Enable HTTPS: 1 (No - HTTP)
# Remote host/IP: smart@smart-dell-sml.crs4.it
# ✓ Keycloak deployed at http://smart-dell-sml.crs4.it:8080
```

### Remote HTTPS - with Certificates on Local Machine
```bash
npm run setup-keycloak
# Choose deployment: Remote (auto-selected)
# Enable HTTPS: 2 (Yes - HTTPS)
# Certificate location: 2 (On this local machine)
# Certificate directory: /path/to/local/certs (or press Enter for default: test/docker-keycloak/certs)
# Remote host/IP: smart@smart-dell-sml.crs4.it
# ✓ Certificates copied to remote and deployed with HTTPS
# ✓ Keycloak accessible at https://smart-dell-sml.crs4.it:8443
```

### Remote HTTPS - with Certificates Already on Remote Server
```bash
npm run setup-keycloak
# Choose deployment: Remote (auto-selected)
# Enable HTTPS: 2 (Yes - HTTPS)
# Certificate location: 1 (Already on the remote server)
# Certificate directory on remote: /home/smart/existing-certs
# Remote host/IP: smart@smart-dell-sml.crs4.it
# ✓ Uses existing certificates on remote server
# ✓ Keycloak deployed with HTTPS at https://smart-dell-sml.crs4.it:8443
```

## Features

### ✅ Local Deployment
- **HTTP Mode**: Development environment, no certificates needed
- **HTTPS Mode**: Production-like environment using SSL/TLS certificates
- **Automatic Health Checks**: Waits for Keycloak to be fully ready
- **Docker Integration**: Uses docker-compose for easy container management

### ✅ Remote Deployment via SSH
- **Automatic File Transfer**: Copies docker-compose files via SCP
- **Certificate Management**: Copies certificates to remote server if HTTPS enabled
- **SSH Connectivity**: Verifies SSH connection before deployment
- **Health Checks**: Confirms Keycloak is running on remote server

### ✅ Configuration Management
- **.env Files**: Auto-generated configuration files
- **Certificate Mounting**: Automatic mounting of SSL certificates
- **Hostname Configuration**: Sets proper KEYCLOAK_HOSTNAME for remote servers
- **Port Configuration**: Supports custom ports for HTTPS

## File Structure

```
keycloak-api-manager/
├── docker-compose.yml              # HTTP configuration
├── docker-compose-https.yml         # HTTPS configuration
├── .env                             # Generated by setup script (gitignored)
├── .env.example                     # Reference configuration
└── test/
    └── setup-keycloak.js            # Interactive setup script
```

## Certificate Configuration

### Default Location
For local HTTPS deployments, the script automatically searches for certificates in:
```
test/docker-keycloak/certs/
├── keycloak.crt  (X.509 certificate)
└── keycloak.key  (Private key)
```

**If found**: Script uses them automatically ✅  
**If not found**: Script prompts you to enter a custom path

The default location allows you to:
- Generate certificates once and commit them to the repo
- Run the script without entering certificate path every time
- Keep certificates organized with the deployment infrastructure

### For Remote Deployments - Choosing Between Local and Remote Certificates

When deploying to a remote server with HTTPS, you have two options:

**Option 1: Certificates on Local Machine** (Script copies them automatically)
```bash
Certificate location (1=remote, 2=local): 2
Certificate directory path local (or press Enter for default): [press Enter or enter /path/to/local/certs]
# Script will verify certificates exist locally and copy them to remote
```

**Option 2: Certificates Already on Remote Server**
```bash
Certificate location (1=remote, 2=local): 1
Certificate directory on remote server: /home/user/existing-certs
# Script will use certificates already on the remote server
```

### Custom Local Location
You can specify a different local certificate directory when prompted:
```bash
Certificate directory path local (or press Enter for default): /home/user/my-certs
```

Press Enter without input to accept the default location `test/docker-keycloak/certs/`.

### Certificate Files Required
For HTTPS deployments, ensure the certificate directory contains:
- `keycloak.crt` - X.509 certificate file
- `keycloak.key` - Unencrypted private key file

Example self-signed certificate generation:
```bash
# Generate self-signed certificate for testing
openssl req -x509 -newkey rsa:2048 -keyout keycloak.key \
  -out keycloak.crt -days 365 -nodes \
  -subj "/CN=keycloak.test/O=Test/C=US"

# Place in the default location
mkdir -p test/docker-keycloak/certs
cp keycloak.crt keycloak.key test/docker-keycloak/certs/
```

## Configuration Details

### Environment Variables

**HTTP Version**:
- `KEYCLOAK_HOSTNAME`: Hostname for Keycloak (localhost for local, hostname for remote)

**HTTPS Version**:
- `KEYCLOAK_CERT_PATH`: Path to certificate directory
- `KEYCLOAK_HOSTNAME`: Hostname for Keycloak (must match certificate CN for production)

### Docker Compose Files

**docker-compose.yml** (HTTP):
```yaml
- Image: keycloak/keycloak:latest
- Ports: 8080 (HTTP)
- Database: In-memory (KC_DB: dev-mem)
- Admin Creds: admin:admin
```

**docker-compose-https.yml** (HTTPS):
```yaml
- Image: keycloak/keycloak:latest
- Ports: 8080 (HTTP), 8443 (HTTPS)
- Certificates: Mounted from KEYCLOAK_CERT_PATH
- Admin Creds: admin:admin
```

## Troubleshooting

### SSH Connection Failed
```bash
# Verify SSH access
ssh -v smart@smart-dell-sml.crs4.it 'echo OK'

# Check SSH key permissions
ls -la ~/.ssh/id_ed25519
chmod 600 ~/.ssh/id_ed25519
```

### HTTPS Certificate Issues
```bash
# Verify certificate files exist
ls -la /path/to/certs/keycloak.crt
ls -la /path/to/certs/keycloak.key

# Test certificate validity
openssl x509 -in keycloak.crt -text -noout

# For browser access with self-signed cert:
# - Use curl -k (insecure flag)
# - Add browser exception for the domain
```

### Keycloak Takes Too Long to Start
```bash
# Check container logs
docker-compose -f docker-compose.yml logs -f

# Or remotely
ssh smart@smart-dell-sml.crs4.it 'cd /home/smart/keycloak && docker-compose -f docker-compose-https.yml logs -f'
```

### Port Already in Use
```bash
# Check what's using the port
lsof -i :8080
lsof -i :8443

# Kill existing container
docker-compose down
```

## Running Tests with Different Deployments

After deploying Keycloak with the setup script, run tests:

```bash
# Tests will automatically detect and connect to Keycloak
npm test

# The test setup handles:
# - Local HTTP: Connects to http://localhost:8080
# - Local HTTPS: Connects to https://localhost:8443
# - Remote: Can be configured in test/config/default.json
```

## Advanced Configuration

### Custom Keycloak Version
Edit `docker-compose.yml` or `docker-compose-https.yml`:
```yaml
services:
  keycloak:
    image: keycloak/keycloak:25.0  # Change version here
```

### Custom Database
Edit docker-compose files, change `KC_DB`:
```yaml
environment:
  KC_DB: postgres  # Instead of dev-mem
  KC_DB_URL_HOST: postgres-host
  KC_DB_URL_PORT: 5432
  KC_DB_USERNAME: keycloak
  KC_DB_PASSWORD: password
```

### Additional Environment Variables
Add to `.env`:
```bash
KC_LOG_LEVEL=INFO
KC_METRICS_ENABLED=true
KC_CACHE=ispn
```

## Support

For issues or questions:
- Check Docker logs: `docker-compose logs -f`
- Check Keycloak admin console: http://localhost:8080
- Review certificates: `openssl x509 -in keycloak.crt -text -noout`
- Test connectivity: `curl -k https://localhost:8443/health/ready`
